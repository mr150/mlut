@use 'sass:map';
@use 'sass:list';
@use 'sass:string';
@use 'sass:meta';
@use 'sass-true' as *;
@use 'tools' as ml;

ml.$utils-data: map.deep-merge(
	ml.$utils-data,
	('utils':
	(
		'registry': (
			'Gc': (
				'properties': grid-column,
				'value-type': ('unitless', 'css-kw'),
				'multi-list-separator': '/',
			),
			'Red': (
				'properties': --reputation,
				'value-type': ('number', ml.$tGVcp, 'cust-prop', 'cp-suffix'),
			),
			'-Tst': (
				'properties': --testou,
				'value-type': ('cust-prop', ml.$tGVcp, 'cp-suffix'),
			),
			'Ai': (
				'keywords': (
					'e': end,
					'b': baseline,
					'c': center,
				),
				'value-type': ml.$util-type-keyword,
			),
			'Animtf': (
				'keywords': 'timing-functions',
				'value-type': ml.$util-type-keyword,
			),
			'Trs': (
				'keywords': 'timing-functions',
			),
		),
		'variables': (
			'testVar': 1989px,
			'trsduDef': 0.3s,
			'opDef': 0.64,
			'cPrm0': #60c,
		),
		'keywords': (
			'timing-functions': (
				'e': ease,
				'ei': ease-in,
				'eo': ease-out,
			),
		),
	),
	'general': (
		'keywords': (
			'colors': (
				'prm0': #c06,
				'sec0': #0c6,
				'varFb': (204, 0, 102),
			),
		),
	),
	),
);

@function cp-suffix($value, $data: ()) {
	@return string.insert($value + '', '-suf', -2);
}

ml.$utils-config: map.set(
	ml.$utils-config,
	'value-converters',
	'cp-suffix',
	meta.get-function('cp-suffix')
);

@include describe('tools/functions/utils/') {
	@include describe('convert-util-value') {
		$-tests: (
			'converts number': (
				(200, 'W'): 200px,
				('=200', 'W'): 200,
				('20vw', 'W'): 20vw,
				(300, 'Fw'): 300,
				(2su, 'Fz'): ml.sur(2),
				(2su, 'P'): ml.sur(2) ml.su(2),
				(200x, 'W'): 200ex,
				('16/9', 'Ar'): string.unquote('16/9'),
				(70p, 'Op'): 0.7,
				('0.8', 'Op'): 0.8,
			),
			'converts global CSS keyword': (
				('a', 'W'): auto,
				('=a', 'W'): a,
			),
			'converts variables': (
				('$testVar', 'W'): map.get(ml.$utils-data, 'utils', 'variables', 'testVar'),
				('$undefVar', 'W'): string.unquote('ERROR: Undefined variable: `$undefVar`'),
			),
			'converts custom property with fallback': (
				('-myCard?200', 'W'): var(--ml-myCard, 200px),
				('-myCard?a', 'W'): var(--ml-myCard, auto),
				('-cardFw?500', 'Fw'): var(--ml-cardFw, 500),
				('-myVar?=200', 'W'): var(--ml-myVar, 200),
				('-myCard?-defWd?150', 'W'): var(--ml-myCard, var(--ml-defWd, 150px)),
			),
			'applys several converters as pipeline': (
				('-css-var', 'Red'): var(--ml-css-var-suf),
				(22, 'Red'): 22px,
				('-css-var', '-Tst'): var(--ml-css-var),
			),
			'converts property abbreviation': (
				('bgc', 'Trs'): background-color,
				('=bgc', 'Trs'): bgc,
			),
			'converts utility keyword': (
				('c', 'Ai'): center,
				('ei', 'Animtf'): ease-in,
			),
			'converts colors': (
				('t', 'C'): transparent,
				('$cPrm0*20p', 'C'): rgba(102, 0, 204, 0.2),
				('#60c*20p', 'C'): rgba(102, 0, 204, 0.2),
				('prm0*$opDef', 'C'): rgba(204, 0, 102, 0.64),
				('prm0*-co', 'C'): rgba(204, 0, 102, var(--ml-co, 1)),
				('-co?varFb*-al?70p', 'C'): rgba(var(--ml-co, 204, 0, 102), var(--ml-al, 0.7)),
				('#c06*20', 'C'): rgba(204, 0, 102, 20),
				('prm10*-co', 'C'): string.unquote('prm10*-co'),
				('-color*20p', 'C'): rgba(var(--ml-color), 0.2),
			),
			'converts values list': (
				('1r:2:5p', 'Bdrs'): 1rem 2px 5%,
				('1r:=10x', 'M'): 1rem 10x,
				('3su:16:a', 'M'): ml.su(3) 16px auto,
				('c:-trsdu:ei', 'Trs'): color var(--ml-trsdu) ease-in,
				('cc:prm0*5p', 'C'): currentColor rgba(204, 0, 102, 0.05),
			),
			'converts values multi list': (
				('1r:2/5p', 'Bdrs'): list.slash(1rem 2px, 5%),
				('bdc:3s,c:$trsduDef', 'Trs'): (border-color 3s, color 0.3s),
				('3/5', 'Gc'): list.slash(3, 5),
			),
		);

		@each $test, $data in $-tests {
			@include it($test) {
				@each $args, $expect in $data {
					@include assert-equal(
						ml.convert-util-value($args...),
						$expect,
						$inspect: true,
					);
				}
			}
		}
	}
}
